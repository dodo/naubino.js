((function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};window.onload=function(){return window.naubino=Naubino.constructor()},this.Naubino={constructor:function(){return this.graph=new this.Graph,this.colors=this.Settings.colors.output,this.init_dom(),this.setup_keybindings(),this.setup_cursorbindings(),this.state_machine=new this.NaubMachine,this.rules=new this.TestCase,this.state_machine.menu_play.dispatch()},init_dom:function(){return this.overlay_canvas=document.getElementById("overlay_canvas"),this.menu_canvas=document.getElementById("menu_canvas"),this.world_canvas=document.getElementById("world_canvas"),this.background_canvas=document.getElementById("background_canvas"),this.background=new this.Background(this.background_canvas),this.game=new this.Game(this.world_canvas,this.graph),this.menu=new this.Menu(this.menu_canvas),this.overlay=new this.Overlay(this.overlay_canvas)},setup_keybindings:function(){return this.keybindings=new this.KeyBindings,window.onkeydown=a(function(a){return this.keybindings.keydown(a)},this),window.onkeyup=a(function(a){return this.keybindings.keyup(a)},this),this.keybindings.enable(32,a(function(){return this.state_machine.menu_pause.dispatch()},this))},setup_cursorbindings:function(){var b,c,d;return c=a(function(a){return this.menu.move_pointer(a.pageX-this.overlay_canvas.offsetLeft,a.pageY-this.overlay_canvas.offsetTop),this.game.move_pointer(a.pageX-this.overlay_canvas.offsetLeft,a.pageY-this.overlay_canvas.offsetTop)},this),d=a(function(a){return this.game.unfocus(a.pageX-this.overlay_canvas.offsetLeft,a.pageY-this.overlay_canvas.offsetTop)},this),b=a(function(a){return this.menu.click(a.pageX-this.overlay_canvas.offsetLeft,a.pageY-this.overlay_canvas.offsetTop),this.game.click(a.pageX-this.overlay_canvas.offsetLeft,a.pageY-this.overlay_canvas.offsetTop)},this),this.overlay_canvas.addEventListener("mousedown",b,!1),this.overlay_canvas.addEventListener("mouseup",d,!1),this.overlay_canvas.addEventListener("mousemove",c,!1),this.overlay_canvas.addEventListener("mouseout",d,!1),this.overlay_canvas.addEventListener("touchstart",b,!1),this.overlay_canvas.addEventListener("touchend",d,!1),this.overlay_canvas.addEventListener("touchmove",c,!1)}}})).call(this),function(){Naubino.Settings={pre_rendering:!0,gravity:{menu:!0,game:!0},fps:20,show_numbers:!1,colors:{output:[[229,53,23,1,"red"],[226,0,122,1,"pink"],[151,190,13,1,"green"],[0,139,208,1,"blue"],[100,31,128,1,"purple"],[255,204,0,1,"yellow"]],high_contrast:[[255,0,0,1,"hcred"],[0,0,0,1,"hcblack"],[255,255,0,1,"hcyellow"],[0,224,0,1,"hcgreen"],[128,0,128,1,"hcpurple"],[0,128,224,1,"hcblue"]],normal_colors:[[255,0,0,1,"red"],[255,153,0,1,"Vitamin C"],[255,255,0,1,"Yellow"],[0,204,0,1,"Astroturf"],[0,153,204,1,"Office Blue"]],cuddle_bunny:[[75,136,95,1,"cuddling green"],[73,37,13,1,"midnight fudge"],[174,49,45,1,"cuddling red"],[173,165,64,1,"cuddling yellow"],[202,202,182,1,"ill beige"]],70:[[255,232,222,1],[191,73,73,1],[166,30,30,1],[38,110,128,1],[41,14,3,1,"tell me"]],lip:[[82,195,193,1],[125,97,83,1],[246,153,167,1],[198,190,99,1],[147,208,189,1]]}}}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};Naubino.NaubMachine=a=function(){function a(){this.graph=Naubino.graph,this.game=Naubino.game,this.Signal=window.signals.Signal,this.fsm=this.create_fsm(),this.add_signals(),this.add_generic_listeners(),this.add_listeners()}return a.prototype.create_fsm=function(){return StateMachine.create({initial:"menu",events:[{name:"play",from:"menu",to:"playing"},{name:"pause",from:"playing",to:"paused"},{name:"play",from:"paused",to:"playing"},{name:"unpause",from:"paused",to:"playing"},{name:"win",from:"playing",to:"won"},{name:"lose",from:"playing",to:"lost"},{name:"exit",from:"playing",to:"menu"},{name:"show_help",from:"menu",to:"help"},{name:"hide_help",from:"help",to:"menu"},{name:"retry",from:"lost",to:"playing"}],callbacks:{onenterplaying:function(a,b,c){return Naubino.game.start_timer(),Naubino.menu.switch_to_playing(),Naubino.rules.run()},onleaveplaying:function(a,b,c){},onpaused:function(a,b,c){return Naubino.game.stop_timer(),Naubino.menu.switch_to_paused(),Naubino.rules.halt()},onpause:function(a,b,c){},onunpause:function(a,b,c){return Naubino.game.start_timer()},onexit:function(a,b,c){}}})},a.prototype.add_signals=function(){return this.mousedown=new this.Signal,this.mouseup=new this.Signal,this.mousemove=new this.Signal,this.keydown=new this.Signal,this.keyup=new this.Signal,this.touchstart=new this.Signal,this.touchend=new this.Signal,this.touchmove=new this.Signal,this.naub_replaced=new this.Signal,this.naub_destroyed=new this.Signal,this.cycle_found=new this.Signal,this.menu_pause=new this.Signal,this.menu_play=new this.Signal,this.menu_exit=new this.Signal,this.menu_help=new this.Signal},a.prototype.add_generic_listeners=function(){return this.menu_pause.add(b(function(){return this.fsm.pause(),console.log("menu: pause")},this)),this.menu_play.add(b(function(){return this.fsm.play(),console.log("menu: play")},this)),this.menu_exit.add(b(function(){return this.fsm.exit(),console.log("menu: exit")},this)),this.menu_help.add(b(function(){return this.fsm.show_help(),console.log("menu: help")},this))},a.prototype.add_listeners=function(){},a}()}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=Object.prototype.hasOwnProperty,e=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};Naubino.RuleSet=a=function(){function a(){this.event=c(this.event,this),this.inner_clock=0,Naubino.game.points=0,this.configure()}return a.prototype.configure=function(){var a;return a=150,Naubino.game.basket_size=a,Naubino.background.basket_size=a,Naubino.state_machine.naub_replaced.add(c(function(){return Naubino.state_machine.graph.cycle_test()},this)),Naubino.state_machine.naub_destroyed.add(c(function(){return Naubino.state_machine.game.points++},this)),Naubino.state_machine.cycle_found.add(c(function(a){return Naubino.state_machine.game.destroy_naubs(a),console.log(a)},this))},a.prototype.run=function(){return this.loop=setInterval(this.event,300),Naubino.background.draw()},a.prototype.halt=function(){return clearInterval(this.loop)},a.prototype.event=function(){var a,b,c,d;return this.inner_clock===0&&(d=Naubino.game.random_outside(),b=d.x,c=d.y,Naubino.game.create_naub_pair(b,c),a=Naubino.game.count_basket(),a.length>0&&console.log(a),console.log("new naubs!")),this.inner_clock=(this.inner_clock+1)%10},a.prototype.clear=function(){return Naubino.game.clear(),Naubino.graph.clear(),Naubino.game.points=0},a}(),Naubino.TestCase=b=function(){function b(){var a,c;b.__super__.constructor.call(this),Naubino.Settings.show_numbers=!0,Naubino.game.create_some_naubs(2),Naubino.game.toggle_numbers(),c=function(){return Naubino.game.gravity=!1},setTimeout(c,4e3),a=150,Naubino.game.basket_size=a,Naubino.background.basket_size=a,Naubino.background.draw()}return e(b,a),b.prototype.run=function(){},b.prototype.event=function(){var a;return a=Naubino.game.count_basket(),Naubino.game.destroy_naubs(a)},b}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=Object.prototype.hasOwnProperty;Naubino.KeyBindings=a=function(){function a(){this.keyup=b(this.keyup,this),this.keydown=b(this.keydown,this),this.step=b(this.step,this),this.disable=b(this.disable,this),this.enable=b(this.enable,this),this.bindings={},this.active_bindings={}}return a.prototype.enable=function(a,b,c,d){return this.bindings[a]={down:b,up:c,during:d}},a.prototype.disable=function(a){var b,c;return b=this.active_bindings[a],(c=this.bindings[a])!=null&&typeof c.up=="function"&&c.up(),delete this.bindings[a],delete this.active_bindings[a]},a.prototype.step=function(a){var b,d,e,f,g;f=this.active_bindings,g=[];for(d in f){if(!c.call(f,d))continue;b=typeof (e=this.active_bindings[d]).during=="function"?e.during(a):void 0,g.push(this.active_bindings[d].called=!0)}return g},a.prototype.keydown=function(a){var b,c;b=a.which;if(b in this.bindings&&!(b in this.active_bindings))return typeof (c=this.bindings[b]).down=="function"&&c.down(),this.active_bindings[b]={during:this.bindings[b].during,called:!1}},a.prototype.keyup=function(a){var b,c,d,e,f;d=a.which;if(d in this.active_bindings)return f=this.active_bindings[d],c=f.during,b=f.called,b||typeof c=="function"&&c(),delete this.active_bindings[d],typeof (e=this.bindings[d]).up=="function"?e.up():void 0},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};Naubino.Naub=a=function(){function a(a){this.layer=a,this.remove=b(this.remove,this),this.step=b(this.step,this),this.draw_joins=b(this.draw_joins,this),this.draw=b(this.draw,this),this.size=14,this.physics=new Naubino.PhysicsModel(this),this.shape=new Naubino.Ball(this),this.content=null,this.color_id=this.shape.random_palette_color(),this.physics.attracted_to=this.layer.center.Copy(),this.removed=!1,this.focused=!1,this.disabled=!1,this.joins={},this.drawing_join={},this.shape.pre_render()}return a.prototype.draw=function(a){return this.shape.draw(a)},a.prototype.draw_joins=function(a){var b,c,d;d=this.joins;for(b in d)c=d[b],this.drawing_join[b]&&this.shape.draw_join(a,c)},a.prototype.step=function(a){return this.physics.step(a)},a.prototype.enable=function(){return this.disabled=!1,this.shape.style.fill=Naubino.colors[this.color_id],this.shape.pre_render()},a.prototype.disable=function(){return this.disabled=!0,this.shape.style.fill=[100,100,100,1],this.shape.pre_render()},a.prototype.remove=function(){var a,b,c,d;this.removed=!0,c=this.joins,d=[];for(a in c)b=c[a],delete b.joins[a],d.push(Naubino.graph.remove_join(a));return d},a.prototype.destroy=function(){var a,b,c;c=this.joins;for(a in c)b=c[a],this.drawing_join[a]=!0,b.drawing_join[a]=!1;return this.destroying=!0,this.shape.destroy(this.remove),Naubino.state_machine.naub_destroyed.dispatch(this.number)},a.prototype.join_with=function(a){var b;return b=Naubino.graph.add_join(this,a),this.joins[b]=a,this.drawing_join[b]=!0,a.joins[b]=this,a.drawing_join[b]=!1,b},a.prototype.replace_with=function(a){var b,c,d;return d=function(){var d,e;d=this.joins,e=[];for(b in d)c=d[b],a.join_with(c),delete c.joins[b],e.push(Naubino.graph.remove_join(b));return e}.call(this),this.layer.unfocus(),this.remove(),console.log("replaced "+this.number),Naubino.state_machine.naub_replaced.dispatch(),42},a.prototype.is_joined_with=function(a){var b,c,d,e;c=!1,e=this.joins;for(b in e)d=e[b],d===a&&(c=!0);return c},a.prototype.joined_naubs=function(){var a,b,c,d;b=[],d=this.joins;for(a in d)c=d[a],b.push(c.number);return this.joins},a.prototype.check_joining=function(a){var b,d,e,f,g,h,i,j,k,l;if(this.number!==a.number){d=!0,f=function(){var a,b;a=this.joins,b=[];for(e in a)h=a[e],b.push(h.number);return b}.call(this),k=a.joins;for(e in k){h=k[e];if(l=h.number,c.call(f,l)>=0)d=!1}return j=!this.is_joined_with(a),b=_.keys(this.joins).length===0,g=_.keys(a.joins).length===0,i=this.color_id===a.color_id,!this.disabled&&j&&i&&d&&!b&&!g?(a.replace_with(this),!0):b&&!a.disabled&&!this.disabled?(this.join_with(a),!0):!1}return!1},a.prototype.distance_to=function(a){var b,c,d,e,f,g,h,i,j,k;return a.number!==this.number?(j=this.physics,h=j.pos,i=j.vel,c=j.force,k=a.physics,f=k.pos,g=k.vel,e=k.force,b=f.Copy(),b.Subtract(h),d=b.Length()):NaN},a.prototype.partners=function(){return _.values(this.joins)},a.prototype.focus=function(){return this.focused=!0,this.shape.pre_render(),this.physics.friction=10},a.prototype.unfocus=function(){return this.focused=!1,this.shape.pre_render(),this.physics.friction=this.physics.default_friction},a.prototype.isHit=function(a,b){var c;return c=new b2Vec2(a,b),c.Subtract(this.physics.pos),c.Length()<this.shape.size&&!this.removed&&!this.disabled},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};Naubino.Shape=a=function(){function a(a){this.color_to_rgba=b(this.color_to_rgba,this),this.naub=a,this.pos=a.physics.pos,this.size=this.naub.size,this.frame=this.size+5,this.style={fill:[0,0,0,1]},this.join_style={fill:[0,0,0,1],width:6},this.life_rendering=!1}return a.prototype.draw=function(a){var b,c;return Naubino.Settings.pre_rendering&&!this.life_rendering?(a.save(),b=this.pos.x-this.frame,c=this.pos.y-this.frame,a.drawImage(this.buffer,b,c),a.restore()):this.render(a,this.pos.x,this.pos.y)},a.prototype.draw_frame=function(a){var b,c;return b=this.pos.x-this.frame,c=this.pos.y-this.frame,a.beginPath(),a.moveTo(b,c),a.lineTo(b,this.frame*2+c),a.lineTo(this.frame*2+b,this.frame*2+c),a.lineTo(this.frame*2+b,c),a.lineTo(b,c),a.stroke(),a.closePath()},a.prototype.pre_render=function(a){var b;return this.buffer=document.createElement("canvas"),this.buffer.width=this.buffer.height=this.frame*2,b=this.buffer.getContext("2d"),this.render(b,this.frame)},a.prototype.draw_join=function(a,b){var c,d,e,f,g,h,i,j;g=this.naub.physics.pos,h=b.physics.pos,c=h.Copy(),c.Subtract(g),f=c.Length(),e=this.naub.physics.keep_distance,d=10,i=Math.round((e+d)/(f+d)*10)/10,j=this.join_style.width*i,a.save(),a.strokeStyle=this.color_to_rgba(this.join_style.fill);try{return a.beginPath(),a.moveTo(g.x,g.y),a.lineTo(h.x,h.y),a.lineWidth=j,a.lineCap="round",a.stroke(),a.closePath(),a.restore()}catch(k){return console.log([g.x,g.y]),Naubino.state_machine.menu_pause.dispatch()}},a.prototype.draw_string=function(a,b,c){return c==null&&(c="white"),a.fillStyle=c,a.textAlign="center",a.font=""+(this.size+4)+"px Helvetica",a.fillText(b,0,6)},a.prototype.draw_number=function(a,b){return b==null&&(b=0),this.draw_string(a,this.naub.number)},a.prototype.destroy=function(a){var c;return this.life_rendering=!0,c=b(function(){this.size*=.6,this.join_style.width*=.6,this.join_style.fill[3]*=.6,this.style.fill[3]*=.6;if(this.size<=.1)return clearInterval(this.loop),a.call()},this),this.loop=setInterval(c,40)},a.prototype.color_to_rgba=function(a,b){var c,d,e,f;return b==null&&(b=0),f=Math.round(a[0]+b),e=Math.round(a[1]+b),d=Math.round(a[2]+b),c=a[3],"rgba("+f+","+e+","+d+","+c+")"},a.prototype.random_palette_color=function(){var a,b,c;return b=Naubino.colors,a=Math.round(Math.random()*(b.length-1)),c=b[a],this.style.fill=[c[0],c[1],c[2],1],a},a.prototype.random_color=function(){var a,b,c;return c=Math.random(),b=Math.random(),a=Math.random(),this.style.fill=[c,b,a,1],-1},a}()}.call(this),function(){var a,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};Naubino.Ball=a=function(){function a(b){a.__super__.constructor.call(this,b)}return c(a,Naubino.Shape),a.prototype.render=function(a,b,c){var d,e,f,g;return b==null&&(b=42),c==null&&(c=b),a.save(),f=this.pos,g=this.size,e=0,a.translate(b,c),a.beginPath(),a.arc(e,e,g,0,Math.PI*2,!1),a.closePath(),this.naub.focused?(d=a.createRadialGradient(e,e,g/3,e,e,g),d.addColorStop(0,this.color_to_rgba(this.style.fill,80)),d.addColorStop(1,this.color_to_rgba(this.style.fill,50)),a.fillStyle=d):a.fillStyle=this.color_to_rgba(this.style.fill),a.fill(),this.naub!=null&&this.naub.content!=null&&this.naub.content.call(this,a,e),a.closePath(),a.restore()},a.prototype.draw_join=function(b,c){return a.__super__.draw_join.call(this,b,c)},a}()}.call(this),function(){var a;this.Naubino.PhysicsModel=a=function(){function a(a){this.naub=a,this.pos=new b2Vec2(0,0),this.vel=new b2Vec2(0,0),this.force=new b2Vec2(0,0),this.radius=this.naub.size,this.attracted_to=new b2Vec2(0,0),this.mass=.2,this.friction=this.default_friction=2,this.spring_force=.03,this.keep_distance=this.radius*2+10}return a.prototype.step=function(a){var b;return b=this.force.Copy(),b.Multiply(a),this.pos.Add(b),this.acceleration=new b2Vec2(0,0),this.apply_friction()},a.prototype.gravitate=function(a){var b;a==null&&(a=this.attracted_to);if(!this.naub.focused&&!!this.naub.layer.gravity)return b=a.Copy(),b.Subtract(this.pos),b.Multiply(this.mass),this.accelerate(b)},a.prototype.accelerate=function(a){return this.force.Add(a)},a.prototype.apply_friction=function(){return this.force.Multiply(.4)},a.prototype.follow=function(a){var b;return a==null&&(a=this.attracted_to),b=a.Copy(),b.Subtract(this.pos),b=b.Length(),a.Subtract(this.pos),a.Normalize(),a.Multiply(30*b),this.force.Add(a)},a.prototype.collide=function(a){var b,c,d,e,f,g,h;if(this.naub.number!==a.number){h=a.physics,e=h.pos,f=h.vel,d=h.force,b=e.Copy(),b.Subtract(this.pos),c=b.Length();if(this.naub.number<a.number&&c<this.keep_distance)return g=b.Copy(),g.Normalize(),g.Multiply(this.keep_distance-c),g.Multiply(.6),this.pos.Subtract(g),e.Add(g),this.force.Subtract(g),d.Add(g)}},a.prototype.join_springs=function(a){var b,c,d,e,f,g,h;h=a.physics,e=h.pos,f=h.vel,d=h.force,b=e.Copy(),b.Subtract(this.pos),c=b.Length(),g=b.Copy(),g.Normalize(),g.Multiply(-0.01*this.spring_force*c*c*c%1e3),this.force.Subtract(g),d.Add(g);if(c<this.keep_distance)return g=b.Copy(),g.Normalize(),g.Multiply(this.keep_distance-c),g.Multiply(.3),this.vel.Subtract(g),f.Add(g),this.force.Subtract(g),d.Add(g)},a}()}.call(this),function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}},e=Object.prototype.hasOwnProperty,f=function(a,b){function d(){this.constructor=a}for(var c in b)e.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Naubino.Layer=b=function(){function a(a){this.canvas=a,this.color_to_rgba=d(this.color_to_rgba,this),this.mainloop=d(this.mainloop,this),this.width=this.canvas.width,this.height=this.canvas.height,this.center=new b2Vec2(this.width/2,this.height/2),this.ctx=this.canvas.getContext("2d"),this.pointer=this.center.Copy(),this.objs={},this.objs_count=0,this.paused=!0,this.fps=1e3/Naubino.Settings.fps,this.dt=this.fps/1500}return a.prototype.draw=function(){},a.prototype.step=function(a){},a.prototype.add_object=function(a){return a.center=this.center,this.objs_count++,a.number=this.objs_count,this.objs[this.objs_count]=a},a.prototype.get_object=function(a){return this.objs[a]},a.prototype.remove_obj=function(a){return delete this.objs[a]},a.prototype.clear_objs=function(){return this.objs={}},a.prototype.start_timer=function(){if(this.paused)return this.loop=setInterval(this.mainloop,this.fps),this.paused=!1},a.prototype.stop_timer=function(){return clearInterval(this.loop),this.paused=!0},a.prototype.pause=function(){return this.paused?this.start_timer():this.stop_timer()},a.prototype.mainloop=function(){this.step(this.dt);if(this.drawing)return this.draw()},a.prototype.click=function(a,b){var c,d;this.mousedown=!0,d=[a,b],this.pointer.x=d[0],this.pointer.y=d[1],c=this.get_obj(a,b);if(c)return c.focus(),this.focused_naub=c},a.prototype.unfocus=function(){return this.mousedown=!1,this.focused_naub&&this.focused_naub.unfocus(),this.focused_naub=null},a.prototype.move_pointer=function(a,b){var c;if(this.mousedown)return c=[a,b],this.pointer.x=c[0],this.pointer.y=c[1],c},a.prototype.get_obj=function(a,b){var c,d,e;e=this.objs;for(c in e){d=e[c];if(d.isHit(a,b))return d}},a.prototype.clear=function(){return this.canvas.width=this.canvas.width},a.prototype.color_to_rgba=function(a,b){var c,d,e,f;return b==null&&(b=0),f=Math.round(a[0]+b),e=Math.round(a[1]+b),d=Math.round(a[2]+b),c=a[3],"rgba("+f+","+e+","+d+","+c+")"},a}(),Naubino.Overlay=c=function(){function a(b){a.__super__.constructor.call(this,b),this.fps=200}return f(a,Naubino.Layer),a.prototype.draw_warning=function(a){return this.draw_text(a,"red","bold 34")},a.prototype.draw_text=function(a,b,c){return b==null&&(b="black"),c==null&&(c=15),this.ctx.fillStyle=b,this.ctx.strokeStyle=b,this.ctx.textAlign="center",this.ctx.font=""+c+"px Helvetica",this.ctx.fillText(a,this.center.x,this.center.y)},a}(),Naubino.Background=a=function(){function a(b){a.__super__.constructor.call(this,b),this.fps=200,this.drawing=!0,this.basket_size=170,this.default_thickness=this.basket_thickness=4,this.ttl=12,this.color=[0,0,0,.5]}return f(a,Naubino.Layer),a.prototype.draw=function(){var a,b,c,d;return d=this.canvas.width,c=this.canvas.height,a=d/2,b=c/2,this.ctx.clearRect(0,0,d,c),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(a,b,this.basket_size+this.basket_thickness/2,0,Math.PI*2,!1),this.ctx.lineWidth=this.basket_thickness,this.ctx.strokeStyle=this.color_to_rgba(this.color),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},a.prototype.stop_pulse=function(){return this.pulse_ends=!0},a.prototype.pulse=function(){var a;return this.default_fps=this.fps,this.seed=0,this.fps=50,this.start_timer(),this.animation!=null&&clearInterval(this.animation),a=d(function(){var a;return this.pulse_ends&&Math.abs(this.default_thickness-this.basket_thickness)<1&&(clearInterval(this.animation),delete this.animation,this.pulse_ends=!1,this.basket_thickness=this.default_thickness,this.color[0]=0,this.color[3]=.5),this.basket_thickness=Math.abs(Math.sin(this.seed/this.ttl))*2*this.default_thickness+this.default_thickness,a=Math.sin(this.seed/this.ttl),this.color[0]=Math.abs(a)*200,this.color[3]=Math.abs(a)*.5+.5,this.seed++},this),this.animation=setInterval(a,50)},a.prototype.drawTextAlongArc=function(a,b){var c,d,e,f;b==null&&(b=0),c=a.length*.1,this.ctx.save(),this.ctx.translate(this.center.x,this.center.y),this.ctx.rotate(-1*c/2),this.ctx.rotate(-1*(c/a.length)/2+b);for(e=0,f=a.length;e<f;e++)d=a[e],this.ctx.rotate(c/a.length),this.ctx.save(),this.ctx.translate(0,-1*this.basket_size+15),this.ctx.fillStyle=this.color_to_rgba(this.color),this.ctx.textAlign="center",this.ctx.font="20px Helvetica",this.ctx.fillText(d,0,0),this.ctx.restore();return this.ctx.restore()},a.prototype.draw_marker=function(a,b,c){return c==null&&(c="black"),this.ctx.beginPath(),this.ctx.arc(a,b,4,0,2*Math.PI,!1),this.ctx.arc(a,b,1,0,2*Math.PI,!1),this.ctx.lineWidth=1,this.ctx.strokeStyle=c,this.ctx.stroke(),this.ctx.closePath()},a.prototype.draw_line=function(a,b,c,d,e){return c==null&&(c=this.center.x),d==null&&(d=this.center.y),e==null&&(e="black"),this.ctx.beginPath(),this.ctx.moveTo(a,b),this.ctx.lineTo(c,d),this.ctx.lineWidth=2,this.ctx.strokeStyle=e,this.ctx.stroke(),this.ctx.closePath()},a.prototype.draw_text=function(a,b,c,d){return d==null&&(d="black"),this.ctx.fillStyle=d,this.ctx.strokeStyle=d,this.ctx.textAlign="center",this.ctx.font=""+(this.size+4)+"px Helvetica",this.ctx.fillText(c,a,b)},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=Object.prototype.hasOwnProperty,d=function(a,b){function e(){this.constructor=a}for(var d in b)c.call(b,d)&&(a[d]=b[d]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};Naubino.Menu=a=function(){function a(c){this.mainloop=b(this.mainloop,this),a.__super__.constructor.call(this,c),this.canvas=Naubino.background,this.objs={},this.hovering=!1,this.gravity=Naubino.Settings.gravity.menu,this.listener_size=this.default_listener_size=45,this.fps=50,this.dt=this.fps/100,this.position=new b2Vec2(20,25),this.buttons={play:{"function":function(){return Naubino.state_machine.menu_play.dispatch()},content:function(a){return this.draw_string(a,"")},position:new b2Vec2(65,35)},pause:{"function":function(){return Naubino.state_machine.menu_pause.dispatch()},content:function(a){return this.draw_string(a,"")},position:new b2Vec2(65,35),disabled:!0},help:{"function":function(){return Naubino.state_machine.menu_help.dispatch()},content:function(a){return this.draw_string(a,"?")},position:new b2Vec2(45,65)},exit:{"function":function(){return Naubino.state_machine.menu_exit.dispatch()},content:function(a){return this.draw_string(a,"X")},position:new b2Vec2(14,80)}},this.add_buttons(),this.start_timer()}return d(a,Naubino.Layer),a.prototype.draw_play_icon=function(a){},a.prototype.mainloop=function(){return this.draw(),this.draw_listener_region(),this.step()},a.prototype.step=function(){var a,b,c,d;c=this.objs,d=[];for(a in c)b=c[a],b.step(this.dt),d.push(this.hovering?b.physics.gravitate():b.physics.gravitate(this.position));return d},a.prototype.move_pointer=function(a,b){var c;return c=[a,b],this.pointer.x=c[0],this.pointer.y=c[1],c},a.prototype.add_buttons=function(){var a,b,c,d,e;this.objs.main=new Naubino.Naub(this),this.objs.main.draw=this.draw_main_button,this.objs.main.physics.pos.Set(this.position.x,this.position.y),this.objs.main.physics.attracted_to=this.position.Copy(),d=this.buttons,e=[];for(c in d)a=d[c],this.objs[c]=new Naubino.Naub(this),this.objs[c].physics.pos.Set(a.position.x,a.position.y),this.objs[c].physics.attracted_to.Set(a.position.x,a.position.y),this.objs[c].content=a.content,this.objs[c].shape.pre_render(),this.objs[c].focus=a["function"],a.disabled&&this.objs[c].disable(),b=this.objs[c].join_with(this.objs.main,c),e.push(Naubino.graph.remove_join(b));return e},a.prototype.switch_to_playing=function(){return console.log("switching menu to playing mode"),this.objs.play.disable(),this.objs.pause.enable()},a.prototype.switch_to_paused=function(){return console.log("switching menu to paused mode"),this.objs.play.enable(),this.objs.pause.disable()},a.prototype.draw=function(){var a,b,c;this.ctx.clearRect(0,0,Naubino.world_canvas.width,Naubino.world_canvas.height),this.ctx.save(),c=this.objs;for(a in c)b=c[a],b.disabled||b.draw_joins(this.ctx),b.disabled||b.draw(this.ctx);return this.objs.main.draw(this.ctx),this.objs.main.draw_joins(),this.draw_listener_region(),this.ctx.restore()},a.prototype.draw_main_button=function(a){var b;return b=80,a.save(),a.translate(this.physics.pos.x,this.physics.pos.y),a.rotate(Math.PI/6),a.beginPath(),a.rect(-b/4,-b/4,b/2,b/2),a.fillStyle=this.shape.color_to_rgba(this.shape.style.fill),a.fill(),a.closePath(),a.restore(),a.save(),a.translate(this.physics.pos.x,this.physics.pos.y),a.fillStyle="white",a.textAlign="center",a.font="bold 33px Helvetica",a.fillText(Naubino.game.points,0,10,b),a.restore()},a.prototype.draw_listener_region=function(){return this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(0,15,this.listener_size,0,Math.PI*2,!0),this.ctx.isPointInPath(this.pointer.x,this.pointer.y)?this.hovering||(this.hovering=!0,this.listener_size=90):this.hovering&&(this.hovering=!1,this.listener_size=this.default_listener_size),this.ctx.closePath(),this.ctx.restore()},a}()}.call(this),function(){var a,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=function(a,b){return function(){return a.apply(b,arguments)}};Naubino.Game=a=function(){function a(b,c){this.graph=c,a.__super__.constructor.call(this,b),this.paused=!0,this.drawing=!0,this.focused_naub=null,this.gravity=Naubino.Settings.gravity.game,this.points=-1}return c(a,Naubino.Layer),a.prototype.create_some_naubs=function(a){var b,c,d,e,f,g,h;a==null&&(a=3);for(d=1;1<=a?d<=a:d>=a;1<=a?d++:d--)f=this.random_outside(),b=f.x,c=f.y,Naubino.background.draw_marker(b,c),this.create_naub_pair(b,c);h=[];for(e=1;1<=a?e<=a:e>=a;1<=a?e++:e--)g=this.random_outside(),b=g.x,c=g.y,Naubino.background.draw_marker(b,c),h.push(this.create_naub_triple(b,c));return h},a.prototype.create_naub=function(a,b){var c;return a==null&&(a=this.center.x),b==null&&(b=this.center.y),c=new Naubino.Naub(this),this.add_object(c),c.shape.pre_render(),c.physics.pos.Set(a,b)},a.prototype.create_naub_pair=function(a,b){var c,d,e;return d=new Naubino.Naub(this),e=new Naubino.Naub(this),this.add_object(d),this.add_object(e),d.shape.pre_render(),e.shape.pre_render(),c=Math.random()*Math.PI,d.physics.pos.Set(a,b),e.physics.pos.Set(a,b),d.physics.pos.AddPolar(c,15),e.physics.pos.AddPolar(c,-15),d.join_with(e)},a.prototype.create_naub_triple=function(a,b){var c,d,e,f;return d=new Naubino.Naub(this),e=new Naubino.Naub(this),f=new Naubino.Naub(this),this.add_object(d),this.add_object(e),this.add_object(f),d.shape.pre_render(),e.shape.pre_render(),f.shape.pre_render(),c=Math.random()*Math.PI,d.physics.pos.Set(a,b),e.physics.pos.Set(a,b),f.physics.pos.Set(a,b),d.physics.pos.AddPolar(c,30),f.physics.pos.AddPolar(c,-30),d.join_with(e),e.join_with(f)},a.prototype.toggle_numbers=function(){var a,b,c,d;this.show_numbers==null?this.show_numbers=!0:this.show_numbers=!this.show_numbers,c=this.objs,d=[];for(a in c)b=c[a],b.content=this.show_numbers?b.shape.draw_number:null,d.push(b.shape.pre_render());return d},a.prototype.random_outside=function(){var a,b,c,d;a=100,b=Math.round(Math.random()*3+1);switch(b){case 1:c=this.width+a,d=this.height*Math.random();break;case 2:c=this.width*Math.random(),d=this.height+a;break;case 3:c=0-a,d=this.height*Math.random();break;case 4:c=this.width*Math.random(),d=0-a}return{x:c,y:d}},a.prototype.count_basket=function(){var a,b,c,d,e;a=[];if(this.basket_size!=null){e=this.objs;for(c in e)d=e[c],b=this.center.Copy(),b.Subtract(d.physics.pos),b.Length()<this.basket_size-d.size/2&&a.push(d.number)}return a},a.prototype.destroy_naubs=function(a){var b,c,e,f,g;for(f=0,g=a.length;f<g;f++)c=a[f],this.get_object(c).disable();return b=0,e=d(function(){return b<a.length&&(this.get_object(a[b]).destroy(),b++),setTimeout(e,40)},this),e()},a.prototype.draw=function(){var a,b,c,d;this.ctx.clearRect(0,0,Naubino.world_canvas.width,Naubino.world_canvas.height),this.ctx.save(),c=this.objs;for(a in c)b=c[a],b.draw_joins(this.ctx);d=this.objs;for(a in d)b=d[a],b.draw(this.ctx);return this.ctx.restore()},a.prototype.step=function(a){var b,c,d,e,f;this.naub_forces(a);if(this.mousedown&&this.focused_naub){this.focused_naub.physics.follow(this.pointer.Copy()),e=this.objs;for(b in e){d=e[b];if(this.focused_naub.distance_to(d)<this.focused_naub.size+10){this.focused_naub.check_joining(d);break}}}f=this.objs;for(b in f){c=f[b];if(c.removed)return this.remove_obj(b),42}},a.prototype.naub_forces=function(a){var b,c,d,e,f,g,h,i;f=this.objs,i=[];for(b in f){c=f[b],c.physics.gravitate(),g=c.joins;for(b in g)d=g[b],c.physics.join_springs(d);for(e=0;e<=3;e++){h=this.objs;for(b in h)d=h[b],c.physics.collide(d)}i.push(c.step(a))}return i},a}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};Naubino.Graph=a=function(){function a(){this.cycle_test=b(this.cycle_test,this),this.join_id_sequence=0,this.naubs=[],this.joins={}}return a.prototype.update_naub_list=function(){var a,b,d,e,f;this.naubs=[],e=this.joins,f=[];for(b in e)d=e[b],f.push(function(){var b,e;e=[];for(a=0;a<=1;a++)e.push((b=d[a],c.call(this.naubs,b)<0)?this.naubs.push(d[a]):void 0);return e}.call(this));return f},a.prototype.add_join=function(a,b){var c;return this.join_id_sequence++,c=[a.number,b.number],this.joins[this.join_id_sequence]=c,this.update_naub_list(),this.join_id_sequence},a.prototype.remove_join=function(a){return delete this.joins[a],this.update_naub_list()},a.prototype.clear=function(){return this.join_id_sequence=0,this.naubs=[],this.joins={}},a.prototype.join_list=function(){var a,b,c,d;console.log("joinList"),c=this.joins,d=[];for(a in c)b=c[a],d.push(console.log(a+" "+b));return d},a.prototype.dotty=function(){var a,b,c,d;return a="graph G {\n",d=function(){var a,d;a=this.joins,d=[];for(b in a)c=a[b],d.push(c[0]+" -- "+c[1]);return d}.call(this),a+=d.join("\n")+"}",console.log(a)},a.prototype.partners=function(a,b){var d,e,f,g;b==null&&(b=null),f=[],g=this.joins;for(d in g)e=g[d],c.call(e,a)>=0&&c.call(e,b)<0&&f.push(e[e.indexOf(a)^1]);return f},a.prototype.cycle_test=function(a){var b,c,d,e,f,g,h,i,j,k,l;c=[],this.dfs_map=[],j=this.naubs;for(h=0,i=j.length;h<i;h++)f=j[h],this.dfs_map[f]={naub:f,dfs_num:0,color:0};this.seq_num=1,k=this.dfs_map;for(f in k)l=k[f],g=l.naub,e=l.dfs_num,b=l.color,e===0&&(d=this.dfs(g),c=_.union(c,d))},a.prototype.dfs=function(a,b){var c,d,e,f,g,h;b==null&&(b=null),c=[],this.dfs_map[a].dfs_num=this.seq_num,this.seq_num++,this.dfs_map[a].color=1,h=this.partners(a,b);for(f=0,g=h.length;f<g;f++)e=h[f],this.dfs_map[e].dfs_num===0&&(c=_.union(c,this.dfs(e,a))),this.dfs_map[e].color===1&&(d=this.cycle_list(a,e),d.length>0&&Naubino.state_machine.cycle_found.dispatch(d));return this.dfs_map[a].color=2,c},a.prototype.cycle_list=function(a,c){var d,e;return d=_.select(this.dfs_map,b(function(a){var b,d;return d=a.dfs_num,b=a.color,d>=this.dfs_map[c].dfs_num&&b===1},this)),d.sort(function(a,b){return a.dfs_num-b.dfs_num}),e=_.pluck(d,"naub"),e},a}()}.call(this);